<!DOCTYPE html>
<html>
  <head>
    <title>JSONL Generator</title>
    <link rel="stylesheet" href="app.css" />
  </head>
  <body>
    <h1>JSONL Generator</h1>
    <form>
      <div>
        <label for="API_KEY">Open AI API Key:</label>
        <input type="password" id="API_KEY" name="API_KEY" required />
      </div>
      <div>
        <label for="json-file">Select a JSON file:</label>
        <input type="file" id="json-file" name="json-file" accept=".json" />
      </div>
      <div>
        <label for="jsonl-preview">Preview the first 50 lines of the generated JSONL:</label>
        <textarea id="jsonl-preview" rows="10" readonly></textarea>
      </div>
      <div>
        <button id="upload-button" type="button">Upload JSONL</button>
      </div>
      <div>
        <label for="upload-result">Upload Result:</label>
        <textarea id="upload-result" rows="10" readonly></textarea>
      </div>
      <div>
        <label for="training-file">File Id for fine tuning:</label>
        <input type="text" id="training-file" name="training-file" value="file-cEMKXereho73hx9RRSoBGpOM"/>
      </div>
    <div>
      <label for="model">Model:</label>
      <input type="text" id="model" name="model" value="davinci" />
    </div>      
      <div>
        <button id="fine-tune-button" type="button">Fine-tune</button>
  		</div>
      <div>
        <label for="fine-tune-result">Fine-tune Result:</label>
        <textarea id="fine-tune-result" rows="10" readonly></textarea>
      </div>
      
      <button id="list-button" type="button">List Fine-tunes</button>
      <div>
        <table id="fine-tunes-table">
          <thead>
            <tr>
              <th>Id</th>
              <th>Fine tuned model</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </form>
    <script>
function extract_text(variations) {
  const text = variations
    .filter((variation) => variation.body && variation.body.blocks)
    .map((variation) =>
      variation.body.blocks
        .filter((block) => block.paragraph && block.paragraph.blocks)
        .map((block) =>
          block.paragraph.blocks
            .filter((b) => b.text && b.text.text)
            .map((b) => b.text.text)
            .join(" ")
        )
        .join(" ")
    )
    .join(" ");
  return text;
}

function handleFileSelect(event) {
  const input = event.target;
  if (!input || !input.files || input.files.length === 0) {
    return;
  }
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = function () {
    const json = JSON.parse(reader.result);
    const documents = json.documents;
    const jsonl = documents.map((document) => {
      const title = document.published.title;
      const text = extract_text(document.published.variations);
      return { prompt: title, completion: text };
    });
    const jsonlString = jsonl.map((line) => JSON.stringify(line)).join("\n");
    const preview = document.getElementById("jsonl-preview");
    preview.value = jsonlString.split("\n").slice(0, 50).join("\n");
  };
  reader.readAsText(file);
}

function uploadJSONL(jsonl) {
  const endpoint = "https://api.openai.com/v1/files";
  const purpose = "fine-tune";
  const file = new Blob([jsonl], { type: "text/plain" });
  const API_KEY = document.getElementById("API_KEY").value;
  const formData = new FormData();
  formData.append("purpose", purpose);
  formData.append("file", file);
  const xhr = new XMLHttpRequest();
  xhr.open("POST", endpoint);
  xhr.setRequestHeader("Authorization", "Bearer " + API_KEY);
  xhr.onload = function () {
    const result = JSON.parse(xhr.responseText);
    const resultTextarea = document.getElementById("upload-result");
    resultTextarea.value = JSON.stringify(result, null, 2);
  };
  xhr.send(formData);
}

const form = document.querySelector("form");
form.addEventListener("change", handleFileSelect);

const uploadButton = document.getElementById("upload-button");
uploadButton.addEventListener("click", function () {
  const preview = document.getElementById("jsonl-preview");
  const jsonl = preview.value;
  uploadJSONL(jsonl);
});
const fineTuneButton = document.getElementById("fine-tune-button");
fineTuneButton.addEventListener("click", function () {
  const API_KEY = document.getElementById("API_KEY").value;
  const fileId = document.getElementById("training-file").value;
  const model = document.getElementById("model").value;
  const xhr = new XMLHttpRequest();
  xhr.open("POST", "https://api.openai.com/v1/fine-tunes");
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.setRequestHeader("Authorization", "Bearer " + API_KEY);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4 && xhr.status === 200) {
      const result = JSON.parse(xhr.responseText);
      const resultTextarea = document.getElementById("fine-tune-result");
      resultTextarea.value = JSON.stringify(result, null, 2);
    }
  };
  console.log ("fileId: " + fileId);
  const data = JSON.stringify({model: model, training_file: fileId});
  xhr.send(data);
});


const listButton = document.getElementById("list-button");
listButton.addEventListener("click", function () {
  const API_KEY = document.getElementById("API_KEY").value;
  const xhr = new XMLHttpRequest();
  xhr.open("GET", "https://api.openai.com/v1/fine-tunes");
  xhr.setRequestHeader("Authorization", "Bearer " + API_KEY);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4 && xhr.status === 200) {
      const fineTunes = JSON.parse(xhr.responseText).data;
      const tableBody = document.querySelector("#fine-tunes-table tbody");
      tableBody.innerHTML = "";
      fineTunes.forEach((fineTune) => {
        const row = document.createElement("tr");
        const idCell = document.createElement("td");
        idCell.innerText = fineTune.id;
        const fineTunedModelCell = document.createElement("td");
        fineTunedModelCell.innerText = fineTune.fine_tuned_model;
        const statusCell = document.createElement("td");
        statusCell.innerText = fineTune.status;
        const fineTuneIdCell = document.createElement("td");
        fineTuneIdCell.innerText = fineTune.id;
        row.appendChild(idCell);
        row.appendChild(fineTunedModelCell);
        row.appendChild(statusCell);
        tableBody.appendChild(row);
        if (fineTune.model) {
          fineTune.model = fineTune.model.model_id;
        }
      });
    }
  };
  xhr.send();
});



    </script>
  </body>
</html>
